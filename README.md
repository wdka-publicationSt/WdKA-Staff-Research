# WdKA STAFF RESEARCH 2019

Process page <http://publicationstation.wdka.hro.nl/wiki/index.php/Publisher:WdKA_Staff_Research_Publication>

## Depencies:
* Pandoc <http://pandoc.org/>
* Python libraries:
    - Jinja2
        + website: http://jinja.pocoo.org/
        + install: `pip3 install Jinja2`
    - PyYAML
        + website: <https://pyyaml.org/wiki/PyYAMLDocumentation>    
        + install: `pip3 install pyyaml`
         
## Metadata
`publication_metadata.yaml` includes 
* metadata about the publication
*  Table Of Contents (TOC): 

The information contained in this file is used to generate the structure of the publication and its colophon.

## conversion
To convert the .docx files in the docx/ folder to either html, icml or website:

* open terminal
* write `cd ` and drag-and-drop this folder into it.

* run `./make.py html` for html output
* run `./make.py icml` for icml output
* run `./make.py website` for website output
    - website styling is defined in: `website/style.css` as its stylesheet
    - resulting website will be saved in folder `website/` 
* run `./make.py pdf` for PDF output
    - PDF styling is defined in: `pdf/style.pdf.css` as CSS
    - errors found while generating the pdf are stored in `pdf/weasyprint.log`
    - resulting pdf will be saved in `pdf/publication.pdf`


## On CSS for print
[W3C page on CSS Paged Media](https://www.w3.org/TR/css-page-3/) describest in detail: *how pages are generated and laid out to hold fragmented content in a paged presentation*, such as page margins, page size and orientation, headers and footers, page numbering and running headers / footers.

[W3C page on CSS Fragmentation Module](https://www.w3.org/TR/css-break-3/#breaking-controls) explains in detail how page breaks are controlled in CSS.

```
FOLDER STRUCTURE
├─ convert.py
├─ createhtml.py
├── docx (source texts: docx)
│   └──  ....
├── html (converted html)
│   └── ...
├── icml (converted icml)
├─ publication_metadata.yaml
├── README.md
├─ readyaml.py
├── website (website content + structure)
│   └── ...
└── website-templates
    ├── base.html
    ├── contentpage.html
    ├── menu.html
    └── style.css
```

## On images on docx
Because when the images in a docx file are converted by Pandoc they are given a default source and loose their descriptions we devised a different strategies for including images in a word document.

In the word document you include the image as a reference using the follwoing syntax:
`![figure caption](image path)`

As for instance:
`![BluecityLab - Intern Lieke van der Maas working with Kombucha http://www.bluecitylab.nl/](images/AldjevanMeer/bluecitylab.png)`

Ensure that:
* **there is no formatting on that line of text**
* **it is seperate from other text lines with a empty line before and after**

The result, when converted to an HTML will be:
```html
<figure>
    <img src="../images/AldjevanMeer/bluecitylab.png">                  
    <figcaption>BluecityLab - Intern Lieke van der Maas working with Kombucha<a href="http://www.bluecitylab.nl/"><span class="underline">http://www.bluecitylab.nl</span></a>/</figcaption>
</figure>
```

## On PDF post processing

### Output for print

When the PDF's are generated using the browser or weasyprint there are some processing steps we have to take to ensure a smooth printing process.

- **Reduce images to correct resolution.** This step is not strictly necessary. But, as the browser will insert the images in the PDF at their native resolution they can make the final PDF unnecessarily big. That unnecessary weight might slow down later steps in the process. When distributed over the internet is wasteful. Or, when the size of the file is limited (grant applications !) it can be a real hindrance.
- **convert from RGB to CMYK.** As the pdf will be printed using the CMYK colorspace but is generated by the browser in the RGB colorspace it has to be converted. This is quite straightforward using Ghostscript. There is one caveat, while black shapes should only appear on the black plate (key) in CMYK, in RGB the color black is created by combining full red, green and blue. It is possible this 'combined' or 'rich' black is also used in the converted PDF, shapes appear then on all plates, resulting in a less sharp print. The scripts used in this repository were taken from OSP's [pdfutils](https://gitlab.constantvzw.org/osp/tools.pdfutils).
- **Set correct [page boxes](https://www.prepressure.com/pdf/basics/page-boxes).** Page boxes are read by the printer's prepress software, they indicate how the pages should be trimmed and the size of the bleed. In a way they turn the cropmarks from simple black lines into useful information.

The tools used are [ghostscript](https://www.ghostscript.com/), [mutool](https://www.mupdf.com/index.html) and [pdftk](https://www.pdflabs.com/tools/pdftk-the-pdf-toolkit/); Ghostcript to convert the images into the correct colorspace at the right resolution, mutool to set the correct page boxes and, if necessary, to clone pages. Finally we use pdftk to reorder and/or duplicate pages and to combine (concatenate) multiple PDF files into one.

The bash scripts `pdf/bakePDF.sh` and `cover/bakePDF.sh` are used to prepare a correct cover and content pdf for print.

### Output for web / digital distribution

The bash script `pdf/bakePDFWeb.sh` generates a PDF suitable for distribution over the web. This pdf differs from the files intended for print in the following ways:
- Color conversion isn't necessary.
- Images can be encoded at a lower resolution, 150 rather then 300 dpi, reducing the filesize.
- The pageboxes have to be adjusted to hide the cropmarks.
- The cover has to be split into a front and back cover and they have to be inserted at the start and end of the document.
